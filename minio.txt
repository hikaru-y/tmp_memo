ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¸ã¨ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
ãƒãƒ£ãƒƒãƒˆå±¥æ­´

ã‚ãªãŸ:
quarkusã§ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ä½œã£ã¦ã¾ã™ã€‚æœ¬ç•ªç’°å¢ƒã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨ã—ã¦s3ã‚’ä½¿ã£ã¦ã€ç½²åä»˜ãurlã§ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’è¡Œã„ã¾ã™ã€‚ã“ã®éƒ¨åˆ†ã‚’ã€ãƒ­ãƒ¼ã‚«ãƒ«ã®é–‹ç™ºä¸­ã¯minioã§è¡Œã„ãŸã„ã§ã™ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®å ´åˆminioã§ç½²åä»˜ãurlã‚’ç™ºè¡Œã—ã¦ã€ãã‚Œã‚’ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«è¿”ã—ãŸã„ã§ã™ã€‚ã‚„ã‚Šæ–¹ã‚’æ•™ãˆã¦ä¸‹ã•ã„
ChatGPT:
ã„ã„ã§ã™ã­ï¼Quarkus ã§ S3 ç½²åä»˜ãURLã‚’ç™ºè¡Œã—ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ã¯ MinIO ã‚’ä½¿ã†æ§‹æˆã¯ã‚ˆãä½¿ã‚ã‚Œã‚‹ã‚„ã‚Šæ–¹ã§ã™ã€‚å¤§ããªæµã‚Œã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

1. ä¾å­˜é–¢ä¿‚ã‚’è¿½åŠ 
Quarkus ã«ã¯ Amazon S3 æ‹¡å¼µãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚
pom.xml ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

<dependency>
  <groupId>io.quarkus</groupId>
  <artifactId>quarkus-amazon-s3</artifactId>
</dependency>
2. è¨­å®šã‚’ç’°å¢ƒã”ã¨ã«åˆ†ã‘ã‚‹
application.properties ã§ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã£ã¦è¨­å®šã‚’åˆ†ã‘ã¾ã™ã€‚

æœ¬ç•ª (AWS S3)
%prod.quarkus.s3.endpoint-override=https://s3.ap-northeast-1.amazonaws.com
%prod.quarkus.s3.aws.region=ap-northeast-1
%prod.quarkus.s3.aws.credentials.type=default
ãƒ­ãƒ¼ã‚«ãƒ« (MinIO)
%dev.quarkus.s3.endpoint-override=http://localhost:9000
%dev.quarkus.s3.aws.region=us-east-1
%dev.quarkus.s3.aws.credentials.type=static
%dev.quarkus.s3.aws.credentials.static-provider.access-key-id=minioadmin
%dev.quarkus.s3.aws.credentials.static-provider.secret-access-key=minioadmin
%dev.quarkus.s3.path-style-access=true
ãƒã‚¤ãƒ³ãƒˆ:

path-style-access=true ã‚’æŒ‡å®šã—ãªã„ã¨ã€MinIO ã§ã¯ãƒã‚±ãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã‚„ã™ã„ã§ã™ã€‚

MinIO ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¦ãƒ¼ã‚¶/ãƒ‘ã‚¹ã¯ minioadmin:minioadminã€‚

3. S3 ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’æ³¨å…¥
Quarkus ã§ã¯ software.amazon.awssdk.services.s3.S3Client ãŒç›´æ¥æ³¨å…¥ã§ãã¾ã™ã€‚

import jakarta.enterprise.context.ApplicationScoped;
import jakarta.inject.Inject;
import software.amazon.awssdk.services.s3.S3Client;
import software.amazon.awssdk.services.s3.presigner.S3Presigner;
import software.amazon.awssdk.services.s3.model.*;
import software.amazon.awssdk.services.s3.presigner.model.*;

import java.net.URL;
import java.time.Duration;

@ApplicationScoped
public class StorageService {

    @Inject
    S3Client s3;

    @Inject
    S3Presigner presigner;

    private static final String BUCKET = "my-bucket";

    public URL generatePresignedUploadUrl(String key) {
        PutObjectRequest objectRequest = PutObjectRequest.builder()
                .bucket(BUCKET)
                .key(key)
                .build();

        PutObjectPresignRequest presignRequest = PutObjectPresignRequest.builder()
                .signatureDuration(Duration.ofMinutes(10))
                .putObjectRequest(objectRequest)
                .build();

        return presigner.presignPutObject(presignRequest).url();
    }

    public URL generatePresignedDownloadUrl(String key) {
        GetObjectRequest objectRequest = GetObjectRequest.builder()
                .bucket(BUCKET)
                .key(key)
                .build();

        GetObjectPresignRequest presignRequest = GetObjectPresignRequest.builder()
                .signatureDuration(Duration.ofMinutes(10))
                .getObjectRequest(objectRequest)
                .build();

        return presigner.presignGetObject(presignRequest).url();
    }
}
4. REST ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§è¿”ã™
ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«ç½²åä»˜ãURLã‚’è¿”ã™ API ã‚’ä½œã‚Šã¾ã™ã€‚

import jakarta.ws.rs.*;
import jakarta.ws.rs.core.MediaType;
import jakarta.ws.rs.core.Response;
import java.net.URL;

@Path("/files")
@Produces(MediaType.APPLICATION_JSON)
public class FileResource {

    private final StorageService storageService;

    public FileResource(StorageService storageService) {
        this.storageService = storageService;
    }

    @GET
    @Path("/upload-url")
    public Response getUploadUrl(@QueryParam("filename") String filename) {
        URL url = storageService.generatePresignedUploadUrl(filename);
        return Response.ok("{\"url\": \"" + url.toString() + "\"}").build();
    }

    @GET
    @Path("/download-url")
    public Response getDownloadUrl(@QueryParam("filename") String filename) {
        URL url = storageService.generatePresignedDownloadUrl(filename);
        return Response.ok("{\"url\": \"" + url.toString() + "\"}").build();
    }
}
5. MinIO èµ·å‹•ä¾‹ (Docker)
version: '3.8'
services:
  minio:
    image: quay.io/minio/minio
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
âœ… ã¾ã¨ã‚

æœ¬ç•ªã¯ AWS S3ã€é–‹ç™ºã¯ MinIO ã‚’ä½¿ã„åˆ†ã‘ã‚‹ã«ã¯ Quarkus ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è¨­å®šã‚’åˆ©ç”¨ã™ã‚‹ã€‚

MinIO ç”¨ã«ã¯ endpoint-override ã¨ path-style-access=true ãŒå¿…é ˆã€‚

S3Presigner ã§ç½²åä»˜ãURLã‚’ç”Ÿæˆã—ã€REST API ã§è¿”ã™ã€‚

ã“ã“ã§è³ªå•ã§ã™ãŒã€
ğŸ‘‰ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯ React / Vue / Angular ãªã©ã‚’ä½¿ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ
ï¼ˆPUT ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ä¾‹ã‚’ãƒ•ãƒ­ãƒ³ãƒˆç”¨ã«æ›¸ã„ã¦ãŠãã¨ä¾¿åˆ©ã‹ã¨æ€ã„ã¾ã™ï¼‰

ã‚ãªãŸ:
ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯nuxt3ã§ã™ã€‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã®ä¾‹ã‚’æ›¸ã„ã¦ã»ã—ã„ã§ã™
ChatGPT:
ãªã‚‹ã»ã©ï¼Nuxt3 ãªã‚‰ fetch ã‚„ useFetch ã‚’ãã®ã¾ã¾ä½¿ã£ã¦ç½²åä»˜ãURLã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚
ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ (Quarkus) ãŒè¿”ã™ã®ã¯ã€Œä¸€æ™‚çš„ãªç½²åä»˜ãURLã€ãªã®ã§ã€ãƒ•ãƒ­ãƒ³ãƒˆã¯ãã‚Œã‚’å—ã‘å–ã£ã¦ç›´æ¥ MinIO / S3 ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã‚Œã°OKã§ã™ã€‚

Nuxt3 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å´ã®ä¾‹
1. ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
Quarkus API (/files/upload-url?filename=...) ã‹ã‚‰ç½²åä»˜ãURLã‚’å–å¾—ã—ã¦ã€PUT ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

<script setup lang="ts">
const uploadFile = async (file: File) => {
  // 1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ç½²åä»˜ãURLã‚’å–å¾—
  const { url } = await $fetch<{ url: string }>(
    `/api/files/upload-url?filename=${encodeURIComponent(file.name)}`
  )

  // 2. ç½²åä»˜ãURLã«PUTã§ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  const res = await fetch(url, {
    method: "PUT",
    body: file,
    headers: {
      "Content-Type": file.type, // S3/MinIOã«Content-TypeãŒä¿å­˜ã•ã‚Œã‚‹
    },
  })

  if (!res.ok) {
    throw new Error(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ${res.statusText}`)
  }

  console.log("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸï¼")
}
</script>

<template>
  <input type="file" @change="(e:any) => uploadFile(e.target.files[0])" />
</template>
ğŸ‘‰ ã“ã†ã™ã‚‹ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã¯ç›´æ¥ S3/MinIO ã«é€ã‚‰ã‚Œã‚‹ã®ã§ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ãŒæµã‚ŒãšåŠ¹ç‡çš„ã§ã™ã€‚

2. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
Quarkus API (/files/download-url?filename=...) ã‹ã‚‰ç½²åä»˜ãURLã‚’å–å¾—ã—ã¦ã€ãã‚Œã‚’ãƒªãƒ³ã‚¯ã«è¨­å®šã™ã‚‹ã‹ã€fetchã—ã¦ä¿å­˜ã—ã¾ã™ã€‚

(A) ãƒªãƒ³ã‚¯ã‚’é–‹ãå ´åˆ
<script setup lang="ts">
const getDownloadUrl = async (filename: string) => {
  const { url } = await $fetch<{ url: string }>(
    `/api/files/download-url?filename=${encodeURIComponent(filename)}`
  )
  window.open(url, "_blank") // æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
}
</script>

<template>
  <button @click="getDownloadUrl('example.pdf')">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
</template>
(B) ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§å‡ºã™å ´åˆ
<script setup lang="ts">
const downloadFile = async (filename: string) => {
  const { url } = await $fetch<{ url: string }>(
    `/api/files/download-url?filename=${encodeURIComponent(filename)}`
  )

  const res = await fetch(url)
  if (!res.ok) throw new Error("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•—")

  const blob = await res.blob()
  const link = document.createElement("a")
  link.href = URL.createObjectURL(blob)
  link.download = filename
  link.click()
  URL.revokeObjectURL(link.href)
}
</script>

<template>
  <button @click="downloadFile('example.pdf')">ä¿å­˜</button>
</template>
3. æ³¨æ„ç‚¹
PUT ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ã¨ãã¯ CORS è¨­å®š ãŒå¿…è¦ã§ã™ã€‚
MinIO ã®å ´åˆã¯ mc alias set ã§ç™»éŒ²å¾Œã€æ¬¡ã®ã‚ˆã†ã«ãƒã‚±ãƒƒãƒˆã«CORSã‚’è¨­å®šã—ã¾ã™ã€‚

mc alias set local http://localhost:9000 minioadmin minioadmin
mc cors set local/my-bucket <<EOF
[
  {
    "AllowedOrigin": ["*"],
    "AllowedMethod": ["GET", "PUT"],
    "AllowedHeader": ["*"]
  }
]
EOF
âœ… ã¾ã¨ã‚

Quarkus å´ã§ç½²åä»˜ãURLã‚’è¿”ã™

Nuxt3 å´ã§ã¯ãã® URL ã‚’ fetch ã§ç›´æ¥ PUT (ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰) / GET (ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰)

å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’çµŒç”±ã›ãšã«ã‚„ã‚Šã¨ã‚Šã§ãã‚‹

ğŸ‘‰ è³ªå•ã§ã™ï¼š
ãƒ•ã‚¡ã‚¤ãƒ«åã¯ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åãã®ã¾ã¾ã€ã§è‰¯ã„ã§ã™ã‹ï¼Ÿ
ãã‚Œã¨ã‚‚ã€ŒUUIDãªã©ã‚’ä»˜ä¸ã—ã¦ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–ã€ã—ãŸã„ã§ã™ã‹ï¼Ÿ
ã©ã¡ã‚‰ã®ä¾‹ã‚’æ›¸ã„ãŸæ–¹ãŒå®Ÿéš›ã®é‹ç”¨ã«è¿‘ã„ã§ã—ã‚‡ã†ã‹ã€‚

ã‚ãªãŸ:
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åãã®ã¾ã¾ã€ã§ã™
ChatGPT:
äº†è§£ã§ã™ ğŸ‘
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ãã®ã¾ã¾ä½¿ã†å ´åˆã¯ã€ãƒ•ãƒ­ãƒ³ãƒˆã‹ã‚‰ filename ã‚’ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§é€ã‚Šã€ãã‚Œã‚’ Quarkus å´ã§ç½²åä»˜ãURLç”Ÿæˆã«ä½¿ã†ã€ã¨ã„ã†æµã‚Œã§å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚

1. Quarkus å´ (å¾©ç¿’)
@GET
@Path("/upload-url")
public Response getUploadUrl(@QueryParam("filename") String filename) {
    URL url = storageService.generatePresignedUploadUrl(filename);
    return Response.ok(Map.of("url", url.toString())).build();
}

@GET
@Path("/download-url")
public Response getDownloadUrl(@QueryParam("filename") String filename) {
    URL url = storageService.generatePresignedDownloadUrl(filename);
    return Response.ok(Map.of("url", url.toString())).build();
}
2. Nuxt3 å´ (ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰)
<script setup lang="ts">
const uploadFile = async (file: File) => {
  // 1. ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ãã®ã¾ã¾é€ã£ã¦ç½²åä»˜ãURLã‚’å–å¾—
  const { url } = await $fetch<{ url: string }>(
    `/api/files/upload-url?filename=${encodeURIComponent(file.name)}`
  )

  // 2. PUTã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
  const res = await fetch(url, {
    method: "PUT",
    body: file,
    headers: {
      "Content-Type": file.type,
    },
  })

  if (!res.ok) {
    throw new Error(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ${res.statusText}`)
  }

  alert(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ: ${file.name}`)
}
</script>

<template>
  <input type="file" @change="(e:any) => uploadFile(e.target.files[0])" />
</template>
3. Nuxt3 å´ (ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰)
<script setup lang="ts">
const downloadFile = async (filename: string) => {
  // 1. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ç½²åä»˜ãURLã‚’å–å¾—
  const { url } = await $fetch<{ url: string }>(
    `/api/files/download-url?filename=${encodeURIComponent(filename)}`
  )

  // 2. ãƒ–ãƒ©ã‚¦ã‚¶ã§ä¿å­˜ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
  const res = await fetch(url)
  if (!res.ok) throw new Error("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•—")

  const blob = await res.blob()
  const link = document.createElement("a")
  link.href = URL.createObjectURL(blob)
  link.download = filename  // å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«åãã®ã¾ã¾
  link.click()
  URL.revokeObjectURL(link.href)
}
</script>

<template>
  <button @click="downloadFile('example.pdf')">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
</template>
4. æ³¨æ„ç‚¹
ãƒ•ã‚¡ã‚¤ãƒ«åãã®ã¾ã¾ä¿å­˜ã™ã‚‹å ´åˆã€ä»¥ä¸‹ã®ãƒªã‚¹ã‚¯ã«æ³¨æ„ãŒå¿…è¦ã§ã™ï¼š

è¡çªï¼šåŒã˜åå‰ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ä¸Šæ›¸ãã•ã‚Œã‚‹

XSS/ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼šãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãã¨ãã«ç‰¹æ®Šãªãƒ•ã‚¡ã‚¤ãƒ«å (ä¾‹: "><script>...) ãŒå½±éŸ¿ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹

OSä¾å­˜ï¼šWindows ã¨ Linux ã§ç¦æ­¢æ–‡å­—ãŒé•ã†

ã‚‚ã—ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¦‹ã›ã‚‹è¡¨ç¤ºåã€ã¯å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä¿æŒã—ã¤ã¤ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã¯ UUID + "_" + filename ã¿ãŸã„ãªå½¢å¼ã§ä¿å­˜ã™ã‚‹ã¨å®‰å¿ƒã§ã™ã€‚

ğŸ‘‰ ç¢ºèªã—ãŸã„ã®ã§ã™ãŒã€ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«å°‚ç”¨ãƒã‚±ãƒƒãƒˆ / ãƒ•ã‚©ãƒ«ãƒ€ã‚’åˆ†ã‘ã‚‹ã€äºˆå®šã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
ãã‚Œã¨ã‚‚ã€Œå…¨å“¡ãŒåŒã˜ãƒã‚±ãƒƒãƒˆã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€ã™ã‚‹é‹ç”¨ã‚’è€ƒãˆã¦ã„ã¾ã™ã‹ï¼Ÿ

ã‚ãªãŸ:
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã§ã¯ãªãã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã«è¦ªIDã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æŒ‡å®šã—ã¦ã€ãã®ãƒã‚±ãƒƒãƒˆã®ä¸‹ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ãäºˆå®šã§ã™
ChatGPT:
ãªã‚‹ã»ã©ï¼
ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã€ã§ã¯ãªãã€Œè¦ªIDã”ã¨ã€ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã¾ã¨ã‚ãŸã„ã€ã¨ã„ã†ã“ã¨ã§ã™ã­ã€‚
ã¤ã¾ã‚Š S3 (or MinIO) ä¸Šã§ã¯ã“ã‚“ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã«ãªã‚Šã¾ã™ï¼š

my-bucket/
  parent123/
    file1.pdf
    file2.png
  parent456/
    report.docx
ã“ã‚Œãªã‚‰åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«åã§ã‚‚ã€è¦ªIDã”ã¨ã«åˆ†ã‘ã‚‰ã‚Œã‚‹ã®ã§è¡çªã—ã«ãããªã‚Šã¾ã™ ğŸ‘

1. Quarkus å´ï¼ˆç½²åä»˜ãURLç”Ÿæˆï¼‰
ç½²åä»˜ãURLã‚’ç™ºè¡Œã™ã‚‹ã¨ãã« key ã‚’ parentId/filename å½¢å¼ã«ã—ã¾ã™ã€‚

public URL generatePresignedUploadUrl(String parentId, String filename) {
    String key = parentId + "/" + filename; // ãƒ•ã‚©ãƒ«ãƒ€é¢¨ã®ãƒ‘ã‚¹ã«ã™ã‚‹

    PutObjectRequest objectRequest = PutObjectRequest.builder()
            .bucket(BUCKET)
            .key(key)
            .build();

    PutObjectPresignRequest presignRequest = PutObjectPresignRequest.builder()
            .signatureDuration(Duration.ofMinutes(10))
            .putObjectRequest(objectRequest)
            .build();

    return presigner.presignPutObject(presignRequest).url();
}

public URL generatePresignedDownloadUrl(String parentId, String filename) {
    String key = parentId + "/" + filename;

    GetObjectRequest objectRequest = GetObjectRequest.builder()
            .bucket(BUCKET)
            .key(key)
            .build();

    GetObjectPresignRequest presignRequest = GetObjectPresignRequest.builder()
            .signatureDuration(Duration.ofMinutes(10))
            .getObjectRequest(objectRequest)
            .build();

    return presigner.presignGetObject(presignRequest).url();
}
RESTã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
@GET
@Path("/upload-url")
public Response getUploadUrl(@QueryParam("parentId") String parentId,
                             @QueryParam("filename") String filename) {
    URL url = storageService.generatePresignedUploadUrl(parentId, filename);
    return Response.ok(Map.of("url", url.toString())).build();
}

@GET
@Path("/download-url")
public Response getDownloadUrl(@QueryParam("parentId") String parentId,
                               @QueryParam("filename") String filename) {
    URL url = storageService.generatePresignedDownloadUrl(parentId, filename);
    return Response.ok(Map.of("url", url.toString())).build();
}
2. Nuxt3 å´
ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
<script setup lang="ts">
const uploadFile = async (parentId: string, file: File) => {
  // è¦ªIDã¨ãƒ•ã‚¡ã‚¤ãƒ«åã‚’é€ã‚‹
  const { url } = await $fetch<{ url: string }>(
    `/api/files/upload-url?parentId=${encodeURIComponent(parentId)}&filename=${encodeURIComponent(file.name)}`
  )

  const res = await fetch(url, {
    method: "PUT",
    body: file,
    headers: {
      "Content-Type": file.type,
    },
  })

  if (!res.ok) throw new Error("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—")

  alert(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ: ${file.name}`)
}
</script>

<template>
  <input type="file" @change="(e:any) => uploadFile('parent123', e.target.files[0])" />
</template>
ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
<script setup lang="ts">
const downloadFile = async (parentId: string, filename: string) => {
  const { url } = await $fetch<{ url: string }>(
    `/api/files/download-url?parentId=${encodeURIComponent(parentId)}&filename=${encodeURIComponent(filename)}`
  )

  const res = await fetch(url)
  if (!res.ok) throw new Error("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•—")

  const blob = await res.blob()
  const link = document.createElement("a")
  link.href = URL.createObjectURL(blob)
  link.download = filename
  link.click()
  URL.revokeObjectURL(link.href)
}
</script>

<template>
  <button @click="downloadFile('parent123', 'file1.pdf')">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
</template>
3. é‹ç”¨é¢ã®æ³¨æ„ç‚¹
è¦ªIDã‚’ãã®ã¾ã¾ã‚­ãƒ¼ã«å…¥ã‚Œã‚‹å ´åˆ â†’ äºˆæœŸã—ãªã„æ–‡å­—ï¼ˆ/ ã‚„ ?ï¼‰ãŒå«ã¾ã‚Œã‚‹ã¨S3ã‚­ãƒ¼ã¨ã—ã¦æ‰±ã„ã«ãããªã‚‹ã®ã§ã€UUIDãªã©æ­£è¦åŒ–æ¸ˆã¿ã®IDã‚’ä½¿ã†ã®ãŒãŠã™ã™ã‚ã§ã™ã€‚

åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«åã‚’åŒã˜è¦ªIDã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨å½“ç„¶ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚’è¨±å®¹ã™ã‚‹ã‹ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‹æ±ºã‚ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

MinIO ã‚‚ AWS S3 ã‚‚ã€Œãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€ã¨ã„ã†æ¦‚å¿µã¯ãªãã€å®Ÿéš›ã«ã¯ã‚­ãƒ¼æ–‡å­—åˆ—ã® / åŒºåˆ‡ã‚Šã§ç–‘ä¼¼çš„ã«éšå±¤åŒ–ã—ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚

ğŸ‘‰ è³ªå•ã§ã™ï¼š
ã“ã®ã€Œè¦ªIDã€ã¯ã‚¢ãƒ—ãƒªå´ã® DBã§ç®¡ç†ã—ã¦ã„ã‚‹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®IDï¼ˆä¾‹: projectId, articleId ãªã©ï¼‰ã§ã™ã‹ï¼Ÿ
ãã‚Œã¨ã‚‚ã€Œå¤–éƒ¨ã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒ‡å®šã™ã‚‹æ–‡å­—åˆ—ã€ã§ã—ã‚‡ã†ã‹ï¼Ÿ

ã‚ãªãŸ:
ã¡ã‚‡ã£ã¨å‰ã«æˆ»ã‚Šã¾ã™ãŒã€ã‚‚ã—ä»Šs3ã§å‹•ããƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã‚³ãƒ¼ãƒ‰ãŒã‚ã£ãŸã‚‰ã€minioã®ãƒ‰ãƒƒã‚«ãƒ¼ã®è¨­å®šã‚’ã—ã¦ç«‹ã¡ä¸Šã’ã¦application.propertiesã‚’ãã‚Œã«åˆã‚ã›ã¦è¨­å®šã™ã‚Œã°ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã‚³ãƒ¼ãƒ‰ã‚’ä¸€åˆ‡å¤‰æ›´ã™ã‚‹å¿…è¦ã¯ãªã„ã€ã¨ã„ã†ã“ã¨ã§ã‚ã£ã¦ã¾ã™ã‹
ChatGPT:
ã¯ã„ï¼ãã®ç†è§£ã§ãƒãƒƒãƒãƒªã§ã™ ğŸ‘

ãƒã‚¤ãƒ³ãƒˆã‚’æ•´ç†ã™ã‚‹ã¨ï¼š

âœ… å¤‰æ›´ãŒä¸è¦ãªç†ç”±
S3 ã¨ MinIO ã¯ API äº’æ›
â†’ Quarkus ãŒä½¿ã£ã¦ã„ã‚‹ AWS SDK (S3Client / S3Presigner) ã¯ãã®ã¾ã¾ MinIO ã«ã‚‚æ¥ç¶šã§ãã¾ã™ã€‚

ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®é•ã„ã‚’ application.properties ã§å¸å
â†’ æœ¬ç•ª (AWS S3) ã¨ ãƒ­ãƒ¼ã‚«ãƒ« (MinIO) ã®åˆ‡ã‚Šæ›¿ãˆã¯ application.properties ã® %prod ã¨ %dev ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã§è§£æ±ºã§ãã¾ã™ã€‚

ã‚³ãƒ¼ãƒ‰å´ã¯ã€ŒS3ã«è©±ã™ã€ã¤ã‚‚ã‚Šã§æ›¸ã‘ã°OK
â†’ MinIO ã‚’æ„è­˜ã™ã‚‹å¿…è¦ãªã—ã€‚

ğŸš€ å¿…è¦ãªä½œæ¥­
Docker ã§ MinIO ã‚’ç«‹ã¡ä¸Šã’ã‚‹

version: '3.8'
services:
  minio:
    image: quay.io/minio/minio
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
http://localhost:9001 â†’ MinIO ã‚³ãƒ³ã‚½ãƒ¼ãƒ« (GUI)

http://localhost:9000 â†’ API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ (S3äº’æ›)

Quarkus ã® application.properties ã‚’ dev ç”¨ã«æ›¸ã

%dev.quarkus.s3.endpoint-override=http://localhost:9000
%dev.quarkus.s3.aws.region=us-east-1
%dev.quarkus.s3.aws.credentials.type=static
%dev.quarkus.s3.aws.credentials.static-provider.access-key-id=minioadmin
%dev.quarkus.s3.aws.credentials.static-provider.secret-access-key=minioadmin
%dev.quarkus.s3.path-style-access=true
ãƒã‚±ãƒƒãƒˆã‚’ä½œã‚‹
MinIO ã¯ AWS S3 ã®ã‚ˆã†ã«è‡ªå‹•ã§ãƒã‚±ãƒƒãƒˆã‚’ä½œã£ã¦ãã‚Œãªã„ã®ã§ã€å…ˆã«ä½œæˆã—ã¾ã™ã€‚

# MinIO Client (mc) ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œ
mc alias set local http://localhost:9000 minioadmin minioadmin
mc mb local/my-bucket
âš ï¸ æ³¨æ„ç‚¹
å¿…ãš path-style-access=true ã‚’è¨­å®š
â†’ MinIO ã¯ãƒãƒ¼ãƒãƒ£ãƒ«ãƒ›ã‚¹ãƒˆæ–¹å¼ (bucket.s3.amazonaws.com) ã§ã¯ãªããƒ‘ã‚¹æ–¹å¼ (s3.amazonaws.com/bucket) ãŒå¿…è¦ã€‚

CORS è¨­å®š
â†’ ãƒ•ãƒ­ãƒ³ãƒˆ (Nuxt3) ã‹ã‚‰ç›´æ¥ PUT/GET ã™ã‚‹å ´åˆã¯ã€MinIO ãƒã‚±ãƒƒãƒˆã« CORS è¨­å®šãŒå¿…è¦ã€‚

âœ… ã¾ã¨ã‚

ã€Œä»Š S3 ã§å‹•ã„ã¦ã„ã‚‹ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚’ä¸€åˆ‡å¤‰æ›´ã›ãšã€
â†’ MinIO ã‚’ç«‹ã¡ä¸Šã’ã¦ã€application.properties ã‚’ dev ç”¨ã«æ›¸ãæ›ãˆã‚‹ã ã‘ã§å‹•ä½œã—ã¾ã™ï¼

ğŸ‘‰ ã“ã“ã§ç¢ºèªã§ã™ãŒã€ä»Šã® Quarkus ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯

S3Client / S3Presigner ã‚’ç›´æ¥ä½¿ã£ã¦ã„ã‚‹ï¼Ÿ

ãã‚Œã¨ã‚‚ Quarkus ã® @AmazonS3 CDI Injection ã‚’ä½¿ã£ã¦ã„ã‚‹ï¼Ÿ

ï¼ˆã©ã¡ã‚‰ã‹ã«ã‚ˆã£ã¦è¨­å®šã®æ›¸ãæ–¹ãŒå¾®å¦™ã«å¤‰ã‚ã‚Šã¾ã™ï¼‰

ã‚ãªãŸ:
ä»Šã€æ‰‹å…ƒã«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã§ãã‚‹ç’°å¢ƒãŒãªã„ã®ã§ã‚ã‹ã‚Šã¾ã›ã‚“ãŒã€ã©ã¡ã‚‰ã«ã—ã¦ã‚‚è¨­å®šã®åˆ‡ã‚Šæ›¿ãˆã§OKã€ã¨ã„ã†ã“ã¨ã§ã™ã‚ˆã­ã€ç½²åä»˜ãurlã‚’ä½¿ã†å‰æã§ã‚ã£ã¦ã‚‚ã€‚
ChatGPT:
ã¯ã„ã€ãã®é€šã‚Šã§ã™ï¼ğŸ‘Œ

S3Client / S3Presigner ã‚’ç›´æ¥ä½¿ã£ã¦ã„ã‚‹å ´åˆã§ã‚‚

Quarkus ã® @AmazonS3 ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã§ã‚‚

ğŸ‘‰ ä¸¡æ–¹ã¨ã‚‚ API ã¯ S3 äº’æ›ãªã®ã§ã€MinIO ã«æ¥ç¶šå…ˆã‚’å·®ã—æ›¿ãˆã‚‹ã ã‘ã§å‹•ä½œã—ã¾ã™ã€‚

ç½²åä»˜ãURLã«ã¤ã„ã¦
S3Presigner ãŒç™ºè¡Œã™ã‚‹ç½²åä»˜ãURLã¯ã€ŒS3äº’æ›APIä»•æ§˜ã€ã«åŸºã¥ã„ã¦ç”Ÿæˆã•ã‚Œã¾ã™ã€‚

MinIO ã‚‚ã“ã®ç½²åä»˜ãURL (AWS Signature v4) ã‚’ç†è§£ã§ãã‚‹ã®ã§ã€ãã®ã¾ã¾ä½¿ãˆã¾ã™ã€‚

é•ã„ã¯ ç½²åã«ä½¿ã†ã€Œã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ›ã‚¹ãƒˆåã€ ã ã‘ã€‚
â†’ ã“ã‚Œã¯ application.properties ã® endpoint-override ã‚’ MinIO ã«å‘ã‘ã‚Œã°è‡ªå‹•ã§è§£æ±ºã•ã‚Œã¾ã™ã€‚

ã¤ã¾ã‚Š
âœ… ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã¯ä¸è¦
âœ… application.properties ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åˆ‡ã‚Šæ›¿ãˆã ã‘ã§ AWS S3 â†” MinIO ã‚’ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ã«ä½¿ã„åˆ†ã‘å¯èƒ½
âœ… ç½²åä»˜ãURLã§ã‚‚å•é¡Œãªã—

ğŸ’¡ å®Ÿéš›ã®æµã‚Œã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ï¼š

æœ¬ç•ª â†’ endpoint-override ã‚’ AWS S3 ã«å‘ã‘ã‚‹

ãƒ­ãƒ¼ã‚«ãƒ« â†’ endpoint-override ã‚’ MinIO ã«å‘ã‘ã‚‹

ç”Ÿæˆã•ã‚Œã‚‹ç½²åä»˜ãURLã¯ã€ãã‚Œãã‚Œã®ç’°å¢ƒã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ã£ã¦æ­£ã—ãå‹•ä½œã™ã‚‹

ğŸ‘‰ ã¡ãªã¿ã«ã€ãƒ•ãƒ­ãƒ³ãƒˆï¼ˆNuxt3ï¼‰ã‹ã‚‰ã¯ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ç½²åä»˜ãURLã‚’å©ãã ã‘ãªã®ã§ã€ãƒ•ãƒ­ãƒ³ãƒˆã®ã‚³ãƒ¼ãƒ‰ã‚‚ä¸€åˆ‡å¤‰ãˆã‚‹å¿…è¦ãŒãªã„ã§ã™ã€‚

è³ªå•ã§ã™ãŒï¼š
ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã§ MinIO ã‚’ç«‹ã¡ä¸Šã’ãŸã¨ãã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆNuxt3ï¼‰ã‹ã‚‰ç›´æ¥ PUT/GET ã—ã¦å‹•ä½œç¢ºèªã—ãŸã„ã§ã™ã‹ï¼Ÿ
ãã‚Œã¨ã‚‚ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆQuarkusï¼‰ã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã ã‘ã§æ¤œè¨¼ã§ãã‚Œã°OK ã¨ã„ã†é‹ç”¨ã§ã—ã‚‡ã†ã‹ï¼Ÿ

ã‚ãªãŸ:
ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ç¢ºèªã§ããŸã‚‰ä¾¿åˆ©ã ã¨æ€ã„ã¾ã™
ChatGPT:
ã„ã„ã§ã™ã­ï¼ğŸ™Œ
ãƒ•ãƒ­ãƒ³ãƒˆï¼ˆNuxt3ï¼‰ã‹ã‚‰ç›´æ¥ MinIO ã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¨ã€æœ¬ç•ªã«ä¸Šã’ã‚‹å‰ã« CORS ã‚„ URL å‘¨ã‚Šã®å•é¡Œã‚’æ½°ã›ã‚‹ã®ã§ãŠã™ã™ã‚ã§ã™ã€‚

âœ… ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã§ã®æµã‚Œ
MinIO ã‚’ç«‹ã¡ä¸Šã’ã‚‹ï¼ˆDocker Composeï¼‰

version: '3.8'
services:
  minio:
    image: quay.io/minio/minio
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
MinIOç®¡ç†ã‚³ãƒ³ã‚½ãƒ¼ãƒ«: http://localhost:9001

S3äº’æ›API: http://localhost:9000

ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆ

# MinIO client (mc) ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œ
mc alias set local http://localhost:9000 minioadmin minioadmin
mc mb local/my-bucket
CORS ã‚’è¨­å®šï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‹ã‚‰ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰

mc cors set local/my-bucket <<EOF
[
  {
    "AllowedOrigin": ["http://localhost:3000"], # Nuxt3 devã‚µãƒ¼ãƒãƒ¼ã®URL
    "AllowedMethod": ["GET", "PUT"],
    "AllowedHeader": ["*"]
  }
]
EOF
ğŸ‘‰ ã“ã‚ŒãŒãªã„ã¨ãƒ•ãƒ­ãƒ³ãƒˆã‹ã‚‰ fetch(url, { method: "PUT" }) ã™ã‚‹ã¨ CORSã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚
ğŸ‘‰ æœ¬ç•ªç’°å¢ƒã§ã¯ "AllowedOrigin": ["https://your-frontend-domain.com"] ã®ã‚ˆã†ã«çµã‚‹ã®ãŒãŠã™ã™ã‚ã€‚

Quarkus ã® application.properties ã‚’ dev ç”¨ã«è¨­å®š

%dev.quarkus.s3.endpoint-override=http://localhost:9000
%dev.quarkus.s3.aws.region=us-east-1
%dev.quarkus.s3.aws.credentials.type=static
%dev.quarkus.s3.aws.credentials.static-provider.access-key-id=minioadmin
%dev.quarkus.s3.aws.credentials.static-provider.secret-access-key=minioadmin
%dev.quarkus.s3.path-style-access=true
Nuxt3 ã‹ã‚‰ç½²åä»˜ãURLã‚’å©ã„ã¦ç¢ºèª

ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰: PUT ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é€ä¿¡

ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰: GET ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—

ï¼ˆã“ã‚Œã¯å‰ã«æ›¸ã„ãŸ Nuxt3 ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾ä½¿ãˆã¾ã™ ğŸ‘ï¼‰

âœ… ã“ã‚Œã§ã§ãã‚‹ã“ã¨
Nuxt3 ã‹ã‚‰ http://localhost:8080/api/files/upload-url?... ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

Quarkus ãŒç½²åä»˜ãURLã‚’è¿”ã™

Nuxt3 ãŒãã®ç½²åä»˜ãURLã«ç›´æ¥ PUT ã—ã¦ MinIO ã«ä¿å­˜

MinIO ã®ç®¡ç†ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ãˆã‚‹

åŒã˜æµã‚ŒãŒæœ¬ç•ªï¼ˆAWS S3ï¼‰ã§ã‚‚å‹•ä½œã™ã‚‹

ğŸ’¡ ãƒã‚¤ãƒ³ãƒˆ

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã‚³ãƒ¼ãƒ‰ã¯ ä¸€åˆ‡å¤‰æ›´ä¸è¦

MinIO ã« CORSè¨­å®š ã ã‘è¶³ã™å¿…è¦ãŒã‚ã‚‹

Nuxt3 ã¯ã©ã®ç’°å¢ƒã§ã‚‚ ç½²åä»˜ãURLã‚’å©ãã ã‘ãªã®ã§å¤‰æ›´ä¸è¦

ğŸ‘‰ ã‚‚ã—ã€Œãƒ•ãƒ­ãƒ³ãƒˆã‹ã‚‰å‹•ä½œç¢ºèªã™ã‚‹ã¨ãã«ä¸€ç•ªæœ€åˆã«ã¤ã¾ã¥ããƒã‚¤ãƒ³ãƒˆã€ã‚’æŒ™ã’ã‚‹ã¨ã™ã‚‹ã¨ã€CORS è¨­å®šæ¼ã‚Œãªã‚“ã§ã™ã‘ã©ã€ãã“ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’ã—ã£ã‹ã‚Šæ›¸ã„ã¦ãŠã„ãŸæ–¹ãŒã„ã„ã§ã™ã‹ï¼Ÿ

ã‚ãªãŸ:
ã¯ã„ã€ãŠé¡˜ã„ã—ã¾ã™
ChatGPT:
äº†è§£ã—ã¾ã—ãŸï¼ğŸ™†â€â™‚ï¸
ãƒ•ãƒ­ãƒ³ãƒˆï¼ˆNuxt3ï¼‰ã‹ã‚‰ MinIO ã«ç›´æ¥ PUT/GET ã™ã‚‹æ™‚ã«ä¸€ç•ªã¤ã¾ã¥ãã®ãŒ CORS (Cross-Origin Resource Sharing) ã®è¨­å®šã§ã™ã€‚
ã“ã“ã‚’ãã£ã¡ã‚Šã‚„ã£ã¦ãŠã‘ã°ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚‚æœ¬ç•ªã§ã‚‚å®‰å¿ƒã—ã¦å‹•ã‹ã›ã¾ã™ã€‚

ğŸ”‘ MinIO ã® CORS è¨­å®š
1. MinIO Client (mc) ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
MinIO Client (mc) ã¯ S3 CLI äº’æ›ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
brew ã‚„ curl ã§ç°¡å˜ã«å…¥ã‚Œã‚‰ã‚Œã¾ã™ã€‚

macOS/Linux:

brew install minio/stable/mc
Windows (PowerShell):

choco install minio-client
2. MinIO ã«ã‚¨ã‚¤ãƒªã‚¢ã‚¹ç™»éŒ²
mc alias set local http://localhost:9000 minioadmin minioadmin
local â†’ ä»»æ„ã®åå‰ï¼ˆã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼‰

http://localhost:9000 â†’ MinIO ã‚µãƒ¼ãƒãƒ¼ã® API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

minioadmin:minioadmin â†’ ç’°å¢ƒå¤‰æ•°ã§è¨­å®šã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼å/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰

3. ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆ
mc mb local/my-bucket
4. ãƒã‚±ãƒƒãƒˆã« CORS è¨­å®šã‚’è¿½åŠ 
ä¾‹: Nuxt3 é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ (http://localhost:3000) ã‹ã‚‰ PUT/GET ã‚’è¨±å¯ã™ã‚‹å ´åˆ

mc cors set local/my-bucket <<EOF
[
  {
    "AllowedOrigin": ["http://localhost:3000"],
    "AllowedMethod": ["GET", "PUT"],
    "AllowedHeader": ["*"],
    "ExposeHeader": ["ETag"],
    "MaxAgeSeconds": 3000
  }
]
EOF
ğŸ‘‰ ãƒã‚¤ãƒ³ãƒˆ:

AllowedOrigin: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®URLã‚’æŒ‡å®šï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãªã‚‰ http://localhost:3000ï¼‰

AllowedMethod: GET ã¨ PUT ã‚’è¨±å¯ï¼ˆå¿…è¦ãªã‚‰ POST, DELETE ã‚‚è¿½åŠ å¯èƒ½ï¼‰

AllowedHeader: "*" ã«ã—ã¦ãŠã‘ã° Content-Type ãªã©å…¨éƒ¨è¨±å¯ã•ã‚Œã‚‹

ExposeHeader: ãƒ•ãƒ­ãƒ³ãƒˆã‹ã‚‰å‚ç…§ã—ãŸã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æŒ‡å®šï¼ˆETag ãªã©ï¼‰

MaxAgeSeconds: ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ™‚é–“

5. è¨­å®šã®ç¢ºèª
mc cors list local/my-bucket
âœ… ã“ã‚Œã§ã§ãã‚‹ã“ã¨
Nuxt3 ã‹ã‚‰ Quarkus API (/files/upload-url) ã‚’å©ã„ã¦ç½²åä»˜ãURLã‚’å–å¾—

ãã®ç½²åä»˜ãURLã« fetch(url, { method: "PUT", body: file }) ã§ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

CORS è¨­å®šãŒæ­£ã—ã„ã®ã§ ãƒ–ãƒ©ã‚¦ã‚¶å´ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„

ğŸ”„ æœ¬ç•ªç’°å¢ƒ (AWS S3) ã®å ´åˆ
AWS S3 ãƒã‚±ãƒƒãƒˆã«ã‚‚åŒæ§˜ã« CORS è¨­å®šã‚’å…¥ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã‚³ãƒ³ã‚½ãƒ¼ãƒ« or AWS CLI ã§ä»¥ä¸‹ã‚’è¨­å®šã—ã¾ã™ï¼ˆä¾‹ã¯åŒã˜å†…å®¹ï¼‰:

[
  {
    "AllowedOrigins": ["https://your-frontend-domain.com"],
    "AllowedMethods": ["GET", "PUT"],
    "AllowedHeaders": ["*"],
    "ExposeHeaders": ["ETag"],
    "MaxAgeSeconds": 3000
  }
]
ğŸ‘‰ æœ¬ç•ªã§ã¯ AllowedOrigin ã‚’ * ã«ã›ãšã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’é™å®šã™ã‚‹ã®ãŒã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çš„ã«å¿…é ˆã§ã™ã€‚

âœ… ã¾ã¨ã‚ã‚‹ã¨

ãƒ­ãƒ¼ã‚«ãƒ« (MinIO) â†’ mc cors set ã§è¨­å®š

æœ¬ç•ª (AWS S3) â†’ ãƒã‚±ãƒƒãƒˆCORSè¨­å®šã§åŒã˜å†…å®¹ã‚’è¨­å®š

Quarkus / Nuxt3 ã®ã‚³ãƒ¼ãƒ‰ã¯ä¸€åˆ‡å¤‰æ›´ä¸è¦

ğŸ‘‰ ã“ã“ã§è³ªå•ã§ã™ãŒã€Nuxt3 ã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯ **ã‚µã‚¤ã‚ºãŒå¤§ãã„ï¼ˆæ•°ç™¾MBã¨ã‹å‹•ç”»ãªã©ï¼‰**æƒ³å®šã§ã™ã‹ï¼Ÿ
ãã‚Œã¨ã‚‚ æ•°MBç¨‹åº¦ã®ç”»åƒã‚„PDF ãã‚‰ã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ

ã‚ãªãŸ:
æ•°ç™¾MBç¨‹åº¦ã¾ã§ã¯å¯¾å¿œã—ãŸã„ã§ã™
ChatGPT:
ãªã‚‹ã»ã©ï¼ğŸ‘ æ•°ç™¾ MB ã‚¯ãƒ©ã‚¹ã‚’æ‰±ã†ã¨ãªã‚‹ã¨ã€S3/MinIO å´ã®è¨­å®šã¨ãƒ•ãƒ­ãƒ³ãƒˆã®å®Ÿè£…ã§ã¡ã‚‡ã£ã¨æ°—ã‚’ã¤ã‘ã‚‹ã¹ããƒã‚¤ãƒ³ãƒˆãŒå‡ºã¦ãã¾ã™ã€‚

ğŸ”‘ æ•°ç™¾ MB ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯¾å¿œã®ãƒã‚¤ãƒ³ãƒˆ
1. ãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¶ç´„
fetch(url, { method: "PUT", body: file }) ã§æ™®é€šã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã€‚

ãŸã ã—å¤§å®¹é‡ã ã¨ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ ã‚„ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã®é€²æ—ãŒè¦‹ãˆãªã„å•é¡Œ ãŒå‡ºã‚„ã™ã„ã€‚

XMLHttpRequest ã ã¨ onprogress ã‚¤ãƒ™ãƒ³ãƒˆã§é€²æ—è¡¨ç¤ºã§ãã‚‹ã®ã§ã€æ•°ç™¾ MB ãªã‚‰ã“ã¡ã‚‰ã‚’æ¨å¥¨ã€‚

2. ç½²åä»˜ãURLã®æœ‰åŠ¹æœŸé™
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æœ‰åŠ¹æœŸé™ãŒçŸ­ã„ã¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†å‰ã«æœŸé™åˆ‡ã‚Œã™ã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚

Quarkus å´ã§ç½²åä»˜ãURLã‚’ç”Ÿæˆã™ã‚‹ã¨ãã« æ•°åˆ†ã€œæ•°ååˆ† æœ‰åŠ¹ã«ã™ã‚‹ã®ãŒå®‰å…¨ã€‚

// AWS SDK v2 ä¾‹
S3Presigner presigner = S3Presigner.create();
PutObjectRequest putRequest = PutObjectRequest.builder()
    .bucket(bucketName)
    .key(objectKey)
    .build();
PresignedPutObjectRequest presignedRequest = presigner.presignPutObject(
    r -> r.putObjectRequest(putRequest).signatureDuration(Duration.ofMinutes(30))
);
ğŸ‘‰ 30åˆ† ãã‚‰ã„ã«ã—ã¦ãŠã‘ã°å®‰å¿ƒã€‚

3. S3/MinIO å´ã®åˆ¶é™
å˜ä¸€PUTã®æœ€å¤§ã‚µã‚¤ã‚º

AWS S3 â†’ 5GB

MinIO â†’ S3äº’æ›ãªã®ã§åŒã˜ã 5GB

5GBä»¥ä¸Šã¯ã€Œãƒãƒ«ãƒãƒ‘ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€å¿…é ˆã§ã™ãŒã€æ•°ç™¾ MB ãªã‚‰å˜ä¸€ PUT ã§OKã€‚

4. CORS ã¨ãƒ˜ãƒƒãƒ€ãƒ¼
æ•°ç™¾ MB ã§ã‚‚ CORS è¨­å®šã¯å¤‰ã‚ã‚Šã¾ã›ã‚“ã€‚ãŸã ã— Content-Type ã‚’ã¡ã‚ƒã‚“ã¨æŒ‡å®šã™ã‚‹ã®ãŒæ¨å¥¨ã€‚

await fetch(url, {
  method: "PUT",
  headers: {
    "Content-Type": file.type
  },
  body: file
});
5. ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é€²æ—è¡¨ç¤º (ãŠã™ã™ã‚)
function uploadWithProgress(url: string, file: File, onProgress: (percent: number) => void) {
  return new Promise<void>((resolve, reject) => {
    const xhr = new XMLHttpRequest();
    xhr.open("PUT", url, true);
    xhr.setRequestHeader("Content-Type", file.type);

    xhr.upload.onprogress = (event) => {
      if (event.lengthComputable) {
        const percent = Math.round((event.loaded / event.total) * 100);
        onProgress(percent);
      }
    };

    xhr.onload = () => xhr.status === 200 ? resolve() : reject(new Error(xhr.statusText));
    xhr.onerror = () => reject(new Error("Upload failed"));
    xhr.send(file);
  });
}
ğŸ‘‰ ã“ã‚Œã§ Nuxt3 å´ã§ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼è¡¨ç¤º ãŒã§ãã¾ã™ã€‚

6. æœ¬ç•ªã§ã®è€ƒæ…®
CloudFront çµŒç”±ã§S3ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å ´åˆã€ç½²åä»˜ãURLã¯ CloudFrontç”¨ç½²å ã§ã¯ãªã S3ç›´ç½²å ã‚’ä½¿ã†ã®ãŒä¸€èˆ¬çš„ã€‚

CloudFrontã‚’æŒŸã‚€ãªã‚‰ ã‚ªãƒªã‚¸ãƒ³ã«CORSè¨­å®š ã‚‚å¿…è¦ã€‚

âœ… ã¾ã¨ã‚
æ•°ç™¾ MB ã¾ã§ãªã‚‰ å˜ä¸€PUT + ç½²åä»˜ãURL ã§OK

æœ‰åŠ¹æœŸé™ã¯æœ€ä½ã§ã‚‚ æ•°åˆ†ã€œæ•°ååˆ† ã«è¨­å®š

ãƒ•ãƒ­ãƒ³ãƒˆã¯ XMLHttpRequestã§é€²æ—å¯¾å¿œ æ¨å¥¨

5GBã‚’è¶…ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãªã‚‰ ãƒãƒ«ãƒãƒ‘ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ã«åˆ‡ã‚Šæ›¿ãˆ

ğŸ‘‰ ã”è³ªå•ã§ã™ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ ä¸€åº¦ã«è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã¾ã¨ã‚ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ã™ã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
ãã‚Œã¨ã‚‚åŸºæœ¬çš„ã« 1ãƒ•ã‚¡ã‚¤ãƒ«ãšã¤ï¼ˆæ•°ç™¾MBç¨‹åº¦ï¼‰ ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã‹ï¼Ÿ




é¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“é¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“
ChatGPT ã®å›ç­”ã¯å¿…ãšã—ã‚‚æ­£ã—ã„ã¨ã¯é™ã‚Šã¾ã›ã‚“ã€‚é‡è¦ãªæƒ…å ±ã¯ç¢ºèªã™ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚
